[include chopper_tune.cfg]
[include fillamentSensor.cfg]
# https://github.com/dw-0/kiauh/blob/master/docs/gcode_shell_command.md
[include shell_command.cfg]
# https://docs.cartographer3d.com/
[include cartographer.conf]
# https://github.com/SanaaHamel/nevermore-controller
[include nevermore.conf]
[include mainsail.cfg]
[include test_Speed.cfg]
[include temperaturSensors.conf]
[include macros.conf]
[include config_backup.cfg] 
[include buffer.cfg]
#[include K-ShakeTune/*.cfg]
#[include adxl345.conf]
[virtual_sdcard]
path: ~/printer_data/gcodes
[display_status]
[exclude_object]
[respond]
[virtual_pins]
[gcode_arcs]
resolution: .1
[force_move]
enable_force_move: True
[skew_correction]
#################################################
# MCU Configuration 
#################################################
[mcu] #Fysect Spider V3
serial: /dev/ttyAMA0
restart_method : command

[mcu host]
serial: /tmp/klipper_host_mcu

[mcu Steppers]
serial: /dev/serial/by-id/usb-Klipper_stm32h723xx_3E000F000D51323530383437-if00

[mcu ebb36]
canbus_uuid: 852c7022b5e7 

[printer]
kinematics: corexy
max_velocity: 1000  
max_accel: 60000			      
max_z_velocity: 150
max_z_accel: 100
square_corner_velocity: 25.0



#####################################################################
#      X/Y Stepper Settings
#####################################################################
#_____________________ XY Motor Mapping ____________________________
# 
#                           BACK  
#             Y______________Z1______________X
#              |                            | 
#              |                            | 
#              |                            | 
#          L   |                            |   R
#          E   |                            |   I
#          F   |                            |   G
#          T   |                            |   H
#              |                            |   T
#              |                            | 
#              |  0,0                       | 
#            X1|_Z_______________________Z2_|Y1
#                         
#                         FRONT
#  __________________________________________________________________________
# | DRIVE | STEP pin | DIR pin  | EN pin   | CS PIN   | END_STOP |  Board   |
# |-------|----------|----------|----------|----------|----------|----------|
# | X     | PB14     | PB13     | PB15     | PB0      | EBB36    | Icescrew |
# | X1    | PA9      | PA8      | PA10     | PA4      |          | Icescrew |
# | Y     | PB5      | PPB4     | PB6      | PA2      | PB10     | Icescrew |
# | Y1    | PB8      | PB7      | PB9      | PA1      |          | Icescrew |
# |_______|__________|__________|__________|__________|__________|__________|

#####################################################################
#   XY Stepper
#####################################################################

[stepper_x] #Stepper 1 Supernova
step_pin: Steppers: PC3
dir_pin: !Steppers: PC1
enable_pin: !Steppers: PA1
endstop_pin: ebb36: PB3 #Same as Diag
position_endstop:0
position_max:300
rotation_distance: 40
full_steps_per_rotation:200
microsteps:256
homing_speed:200
second_homing_speed:10

[tmc5160 stepper_x]
cs_pin: Steppers:PB0
spi_bus: spi1
interpolate: false
run_current: 2.2
sense_resistor: 0.075
#driver_TBL: 0
#driver_TOFF: 8
#driver_HEND: 9
#driver_HSTRT: 6
#driver_TPFD: 10
#driver_MULTISTEP_FILT: False


[stepper_x1] #Stepper 2 Supernova
step_pin: Steppers: PA2
dir_pin: !Steppers: PA3
enable_pin: !Steppers: PA4
rotation_distance: 40
full_steps_per_rotation:200
microsteps:256
[tmc5160 stepper_x1]
cs_pin: Steppers:PB2
spi_bus: spi1
interpolate: false
run_current: 2.2
sense_resistor: 0.075
#driver_TBL: 0
#driver_TOFF: 8
#driver_HEND: 9
#driver_HSTRT: 6
#driver_TPFD: 10
#driver_MULTISTEP_FILT: False


[stepper_y] #Stepper 3 Supernova
step_pin: Steppers: PE11
dir_pin: !Steppers: PE9
enable_pin: !Steppers: PE13
endstop_pin: Steppers: PE7 #Same as Diag
position_endstop:0
position_max:300
rotation_distance: 40
full_steps_per_rotation:200
microsteps:256
homing_speed:200
second_homing_speed:10
[tmc5160 stepper_y]
cs_pin: Steppers:PE8
spi_bus: spi1
interpolate: false
run_current: 2.2
sense_resistor: 0.075
#driver_TBL: 0
#driver_TOFF: 8
#driver_HEND: 9
#driver_HSTRT: 6
#driver_TPFD: 10
#driver_MULTISTEP_FILT: False


[stepper_y1] #Stepper 4 Supernova
step_pin: Steppers: PB11
dir_pin: !Steppers: PE15
enable_pin: !Steppers: PB10
rotation_distance: 40
full_steps_per_rotation:200
microsteps:256
[tmc5160 stepper_y1]
cs_pin: Steppers:PE10
spi_bus: spi1
interpolate: false
run_current: 2.2
sense_resistor: 0.075
#driver_TBL: 0
#driver_TOFF: 8
#driver_HEND: 9
#driver_HSTRT: 6
#driver_TPFD: 10
#driver_MULTISTEP_FILT: False


#####################################################################
#   Z Stepper
#####################################################################
[stepper_z]
##	Connected to X-MOT (B Motor)
step_pin: PD14
dir_pin: !PD13
enable_pin: !PD15
rotation_distance: 4
microsteps: 64
full_steps_per_rotation:200
endstop_pin: probe:z_virtual_endstop
position_min: -5
position_max:300
homing_retract_dist: 0
homing_speed: 20

##	Make sure to update below for your relevant driver (2208 or 2209)
[tmc2209 stepper_z]
uart_pin: PD10
interpolate: False
run_current: 1
sense_resistor: 0.110
stealthchop_threshold: 0
driver_TBL: 1
driver_TOFF: 3
driver_HEND: 0
driver_HSTRT: 1

[stepper_z1]
##	Connected to Y-MOT (A Motor)
step_pin: PD5
dir_pin: !PD6
enable_pin: !PD4
rotation_distance: 4
microsteps: 64
full_steps_per_rotation:200  #set to 400 for 0.9 degree stepper

[tmc2209 stepper_z1]
uart_pin: PD7
interpolate: False
run_current: 1
sense_resistor: 0.110
stealthchop_threshold: 0
driver_TBL: 1
driver_TOFF: 3
driver_HEND: 0
driver_HSTRT: 1

## In Z-MOT Position
## Z0 Stepper - Front Left
[stepper_z2]
step_pin: PE6
dir_pin: !PC13
enable_pin: !PE5
rotation_distance: 4
microsteps: 64
full_steps_per_rotation:200

[tmc2209 stepper_z2]
uart_pin: PC14
interpolate: False
run_current: 1
sense_resistor: 0.110
stealthchop_threshold: 0
driver_TBL: 1
driver_TOFF: 3
driver_HEND: 0
driver_HSTRT: 1



#####################################################################
#   Extruder
#####################################################################

# EBB36
[extruder]
step_pin: ebb36: PD0
dir_pin: !ebb36: PD1
enable_pin: !ebb36: PD2
rotation_distance: 35.726
#rotation_distance: 22 
gear_ratio: 60:10			
microsteps: 16
filament_diameter: 1.75
max_extrude_cross_section:2
heater_pin: ebb36: PB13
sensor_type: PT1000
pullup_resistor: 2200
sensor_pin: ebb36: PA3 # TE0 Position
min_temp: 10
max_temp: 500
#max_power: .75
nozzle_diameter:0.5
min_extrude_temp: 170
pressure_advance_smooth_time: 0.030
max_extrude_only_distance: 100.0

[verify_heater extruder]
heating_gain: 0.5
[tmc2209 extruder]
uart_pin: ebb36: PA15
interpolate: false
run_current: 1
sense_resistor: 0.110
stealthchop_threshold: 0

; #####################################################################
; #   Bed Heater
; #####################################################################
[heater_bed]
; ##	SSR Pin - In E2 OUT position
heater_pin: PB3
sensor_type: Generic 3950 
sensor_pin: PB0 # TB Position
#max_power: 0.6
min_temp: 0
max_temp: 120
#control: pid
#pid_kp: 58.437
#pid_ki: 2.347
#pid_kd: 363.769

; #####################################################################
; #	Fan Control
; #####################################################################

[fan]
# DAC between 5V PWM and CPAP -> More linear control over 
# RPM Monitoring to watch over linear RPM response ~40k RPM max speed with tentacool (6k RPM below speked no load max of ~46k RPM)
# Adjusted to work between "off_below" and "max_power" in print start macro
#Enable Pin for Stepper X on Spider for 5V PWM
pin:PD1
tachometer_pin:^PA8
tachometer_ppr: 1
tachometer_poll_interval: 0.0005
max_power:.85
#enable_pin:PC8
#hardware_pwm: True
cycle_time: 0.01 
kick_start_time: 0.01
off_below: 0.12

[controller_fan StepperDrivers]
pin: PA13
heater: extruder
stepper:stepper_x
idle_timeout:600

[output_pin ssr_48]
#E1 SSR 48V
pin:PB7


[controller_fan Pump]
#[fan_generic Pump]
heater: extruder
stepper:stepper_x
shutdown_speed:1
kick_start_time: 1
idle_timeout:1200
pin:PE11
tachometer_pin:PD2
tachometer_ppr:2
hardware_pwm: False
cycle_time: 0.00004 # 25 kHz

[controller_fan Radiator]
stepper:stepper_x
fan_speed: .8
shutdown_speed:1
idle_timeout:600
idle_speed:.2
kick_start_time: 1
pin:PE10
tachometer_pin:PC12
tachometer_ppr:2
hardware_pwm: false
cycle_time: 0.00004 # 25 kHz


[z_tilt]
z_positions: 
    -22.94, -10.300
    153.268, 317.910
    329.476, -10.300
points:
	150,5
	20,200
	280,200
speed: 400
horizontal_move_z: 30
retries: 4
retry_tolerance: 0.0075
  
[gcode_button V_Okey]
pin:^!PA3
press_gcode:
  RESPOND MSG="48V An"
  SET_GCODE_VARIABLE MACRO=_DriverPowerToggle VARIABLE=driver_on VALUE=1
release_gcode:
  RESPOND MSG="48V Aus"
  SET_GCODE_VARIABLE MACRO=_DriverPowerToggle VARIABLE=driver_on VALUE=0



#Only here for the emergency stop
[display]
lcd_type:hd44780
rs_pin:virtual_pin:my_pin1
e_pin:virtual_pin:my_pin2
d4_pin:virtual_pin:my_pin3
d5_pin:virtual_pin:my_pin4
d6_pin:virtual_pin:my_pin5
d7_pin:virtual_pin:my_pin6
kill_pin:^!Steppers:PE5

[input_shaper]
shaper_freq_x: 76.4
shaper_freq_y: 78.8
shaper_type: mzv


; #####################################################################
; #	LED Control
; #####################################################################

[neopixel chamber]
pin: PD3
chain_count: 11
color_order: WRGB

[servo nozzle_brush]
pin: PA2
maximum_servo_angle: 180
minimum_pulse_width: 0.0005
maximum_pulse_width: 0.0025
initial_angle: 180


[axis_twist_compensation]
speed: 200
#   The speed (in mm/s) of non-probing moves during the calibration.
#   The default is 50.
#horizontal_move_z: 5
#   The height (in mm) that the head should be commanded to move to
#   just prior to starting a probe operation. The default is 5.
calibrate_start_x: 20
calibrate_end_x: 280
calibrate_y: 150
calibrate_start_y: 70
calibrate_end_y: 220
calibrate_x: 150

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 23.095
#*# pid_ki = 2.138
#*# pid_kd = 62.359
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 51.791
#*# pid_ki = 1.365
#*# pid_kd = 491.371
#*#
#*# [cartographer scan_model default]
#*# coefficients = 1.4910046548810756,1.9779769787056394,0.9213265878596756,0.5411492489097505,0.2540516768140846,-0.07355566226846853,-0.11347668376118009,0.2132467794089849,0.2473385901078656,0.04296473181145654
#*# domain = 3.2720863104288775e-07,3.3613833021161675e-07
#*# z_offset = 0
#*# reference_temperature = 20.72
